const { exec } = require('child_process');
const fs = require('fs');
const path = require('path');
const { GoogleGenerativeAI } = require("@google/generative-ai");
const youtube = require('./youtube');

// --- –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø ---
const GEN_AI_KEY = process.env.GOOGLE_API_KEY; // –ö–ª—é—á –¥–ª—è Vision
const VISION_MODEL_NAME = "gemini-2.0-flash"; // –ú–æ–∂–Ω–æ gemini-1.5-pro

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è AI
const genAI = GEN_AI_KEY ? new GoogleGenerativeAI(GEN_AI_KEY) : null;

/**
 * –û—Å–Ω–æ–≤–Ω–æ–π –º–µ—Ç–æ–¥: –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–∏–¥–µ–æ –ø–æ —Å—Å—ã–ª–∫–µ.
 * 1. –ü–æ–ª—É—á–∞–µ—Ç —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç –∏ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ (—á–µ—Ä–µ–∑ youtube.js).
 * 2. –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –∫–æ–Ω—Ç–µ–Ω—Ç —á–µ—Ä–µ–∑ Gemini Vision (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ) –∏–ª–∏ –ø—Ä–æ—Å—Ç–æ –¢–µ–∫—Å—Ç.
 * 3. –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä—É { title, analysis }.
 */
async function processVideo(url) {
    if (!genAI) {
        throw new Error("GOOGLE_API_KEY –Ω–µ –Ω–∞–π–¥–µ–Ω. Vision –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω.");
    }

    console.log(`[VISION] –ù–∞—á–∏–Ω–∞—é –∞–Ω–∞–ª–∏–∑ –≤–∏–¥–µ–æ: ${url}`);

    // 1. –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –≤–∏–¥–µ–æ (–¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç + –ú–µ—Ç–∞)
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π youtube —Å–µ—Ä–≤–∏—Å, –æ–Ω –Ω–∞–¥–µ–∂–µ–Ω
    const videoData = await youtube.getTranscript(url);

    if (!videoData) {
        throw new Error("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–∞—á–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –≤–∏–¥–µ–æ (yt-dlp error).");
    }

    // 2. –ì–æ—Ç–æ–≤–∏–º –ø—Ä–æ–º–ø—Ç –¥–ª—è AI
    const model = genAI.getGenerativeModel({ model: VISION_MODEL_NAME });

    // –ï—Å–ª–∏ –µ—Å—Ç—å —Ç–µ–∫—Å—Ç (—Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç), –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –µ–≥–æ ‚Äî —ç—Ç–æ –±—ã—Å—Ç—Ä–µ–µ –∏ —Ç–æ—á–Ω–µ–µ –¥–ª—è —Å—É—Ç–∏
    if (videoData.text) {
        return await analyzeTranscript(model, videoData);
    }

    // –ï—Å–ª–∏ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç–∞ –Ω–µ—Ç (—Ä–µ–¥–∫–æ), –º–æ–∂–Ω–æ –±—ã–ª–æ –±—ã –∫–∞—á–∞—Ç—å –∫–∞–¥—Ä—ã, 
    // –Ω–æ –ø–æ–∫–∞ –≤–µ—Ä–Ω–µ–º –æ—à–∏–±–∫—É, —Ç–∞–∫ –∫–∞–∫ yt-dlp –æ–±—ã—á–Ω–æ –¥–æ—Å—Ç–∞–µ—Ç –≤—Å—ë.
    throw new Error("–£ –≤–∏–¥–µ–æ –Ω–µ—Ç —Å—É–±—Ç–∏—Ç—Ä–æ–≤, –∞–Ω–∞–ª–∏–∑ –Ω–µ–≤–æ–∑–º–æ–∂–µ–Ω.");
}

/**
 * –ê–Ω–∞–ª–∏–∑ —Ç–µ–∫—Å—Ç–æ–≤–æ–π —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∏ –≤–∏–¥–µ–æ.
 */
async function analyzeTranscript(model, videoData) {
    console.log(`[VISION] –ê–Ω–∞–ª–∏–∑–∏—Ä—É—é —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç (${videoData.text.length} —Å–∏–º–≤)...`);

    const prompt = `
    –†–û–õ–¨: –¢—ã ‚Äî –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π –ê–Ω–∞–ª–∏—Ç–∏–∫ –∏ –ö—Ä–µ–∞—Ç–∏–≤–Ω—ã–π –ü–æ–º–æ—â–Ω–∏–∫ (–ê–Ω–Ω–∞).
    –ó–ê–î–ê–ß–ê: –°–¥–µ–ª–∞–π –≥–ª—É–±–æ–∫–∏–π —Ä–∞–∑–±–æ—Ä —ç—Ç–æ–≥–æ –≤–∏–¥–µ–æ.

    –ú–ï–¢–ê–î–ê–ù–ù–´–ï:
    - –ù–∞–∑–≤–∞–Ω–∏–µ: ${videoData.title}
    - –ê–≤—Ç–æ—Ä: ${videoData.author}
    - –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: ${videoData.duration} —Å–µ–∫.

    –¢–†–ê–ù–°–ö–†–ò–ü–¢:
    "${videoData.text.substring(0, 50000)}" 
    (—Ç–µ–∫—Å—Ç –º–æ–∂–µ—Ç –±—ã—Ç—å –æ–±—Ä–µ–∑–∞–Ω, –µ—Å–ª–∏ –æ—á–µ–Ω—å –¥–ª–∏–Ω–Ω—ã–π)

    –¢–†–ï–ë–û–í–ê–ù–ò–Ø –ö –û–¢–í–ï–¢–£ (Markdown):
    1. –ù–∞—á–Ω–∏ —Å –∑–∞–≥–æ–ª–æ–≤–∫–∞ (–ù–∞–∑–≤–∞–Ω–∏–µ –≤–∏–¥–µ–æ).
    2. –†–∞–∑–¥–µ–ª "üí° –ì–ª–∞–≤–Ω–∞—è –º—ã—Å–ª—å": –í 1-2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è—Ö.
    3. –†–∞–∑–¥–µ–ª "üîë –ö–ª—é—á–µ–≤—ã–µ –∏–Ω—Å–∞–π—Ç—ã": –°–ø–∏—Å–æ–∫ –∏–∑ 3-5 —Å–∞–º—ã—Ö –≤–∞–∂–Ω—ã—Ö –∏–¥–µ–π.
    4. –†–∞–∑–¥–µ–ª "‚öôÔ∏è –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏" (–µ—Å–ª–∏ –µ—Å—Ç—å): –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã, –∫–æ–¥, –±–∏–±–ª–∏–æ—Ç–µ–∫–∏, –º–µ—Ç–æ–¥—ã.
    5. –†–∞–∑–¥–µ–ª "üß† –ü—Å–∏—Ö–æ–ª–æ–≥–∏—è/–°–æ—Ñ—Ç-—Å–∫–∏–ª–ª—ã" (–µ—Å–ª–∏ –µ—Å—Ç—å): –û —á–µ–º –≥–æ–≤–æ—Ä–∏–ª–æ—Å—å –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ –ª—é–¥–µ–π.
    6. –†–∞–∑–¥–µ–ª "üìù –ö–æ–Ω—Å–ø–µ–∫—Ç": –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–µ—Ä–µ—Å–∫–∞–∑ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏—è.

    –í–ê–ñ–ù–û: –ü–∏—à–∏ –∂–∏–≤–æ, –∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ –∏ –°–¢–†–û–ì–û –ù–ê –†–£–°–°–ö–û–ú –Ø–ó–´–ö–ï.
    `;

    try {
        const result = await model.generateContent(prompt);
        const response = result.response.text();

        // –§–æ—Ä–º–∏—Ä—É–µ–º –∫–æ–Ω—Ç–µ–Ω—Ç –¥–ª—è Obsidian
        const finalContent = `---
type: video-note
url: https://www.youtube.com/watch?v=${videoData.videoId}
author: ${videoData.author}
date: ${new Date().toISOString().split('T')[0]}
tags: [video, analysis, ai-generated]
---

${response}

---
*–ê–Ω–∞–ª–∏–∑ –≤—ã–ø–æ–ª–Ω–µ–Ω –ê–Ω–Ω–æ–π (Gemini Vision) –∑–∞ ${(videoData.duration / 60).toFixed(1)} –º–∏–Ω –ø—Ä–æ—Å–º–æ—Ç—Ä–∞.*
`;

        return {
            title: videoData.title,
            analysis: finalContent
        };

    } catch (e) {
        console.error("[VISION ERROR]", e);
        throw new Error("–û—à–∏–±–∫–∞ AI –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ä–∞–∑–±–æ—Ä–∞.");
    }
}

module.exports = { processVideo };